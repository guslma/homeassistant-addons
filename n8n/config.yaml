name: n8n
version: "1.115.2"
slug: n8n
description: Plataforma de automação de fluxos de trabalho de código aberto com interface integrada ao Home Assistant (Ingress).
url: https://hub.docker.com/r/n8nio/n8n
arch:
  - amd64
  - aarch64
  - armv7
startup: services
init: false
homeassistant_api: false
host_network: false
ingress: true
ingress_port: 5678
ingress_entry: /
panel_icon: mdi:graph-outline

map:
  - homeassistant_config:rw
  - addon_config:rw

options:
  TZ: America/Sao_Paulo
  N8N_PROTOCOL: http
  DB_TYPE: postgresdb
  DB_POSTGRESDB_DATABASE: n8n
  DB_POSTGRESDB_HOST: db-n8n
  DB_POSTGRESDB_PORT: 5432
  DB_POSTGRESDB_USER: n8n
  DB_POSTGRESDB_PASSWORD: n8n
  EXECUTIONS_DATA_SAVE_ON_PROGRESS: false
  N8N_LOG_LEVEL: info

schema:
  TZ: str
  N8N_PROTOCOL: str
  DB_TYPE: str
  DB_POSTGRESDB_DATABASE: str
  DB_POSTGRESDB_HOST: str
  DB_POSTGRESDB_PORT: int
  DB_POSTGRESDB_USER: str
  DB_POSTGRESDB_PASSWORD: str
  EXECUTIONS_DATA_SAVE_ON_PROGRESS: bool
  N8N_LOG_LEVEL: list(error|warn|info|debug|silent)

environment:
  TZ: $TZ
  N8N_PROTOCOL: $N8N_PROTOCOL
  DB_TYPE: $DB_TYPE
  DB_POSTGRESDB_DATABASE: $DB_POSTGRESDB_DATABASE
  DB_POSTGRESDB_HOST: $DB_POSTGRESDB_HOST
  DB_POSTGRESDB_PORT: $DB_POSTGRESDB_PORT
  DB_POSTGRESDB_USER: $DB_POSTGRESDB_USER
  DB_POSTGRESDB_PASSWORD: $DB_POSTGRESDB_PASSWORD
  EXECUTIONS_DATA_SAVE_ON_PROGRESS: $EXECUTIONS_DATA_SAVE_ON_PROGRESS
  N8N_LOG_LEVEL: $N8N_LOG_LEVEL
  # Configurações especiais para Ingress funcionar
  N8N_HOST: localhost
  N8N_EDITOR_BASE_URL: /api/hassio_ingress/
  N8N_PROTOCOL: http
  WEBHOOK_URL: /api/hassio_ingress/
  N8N_PORT: 5678

services:
  db-n8n:
    image: postgres:14.2
    restart: always
    environment:
      POSTGRES_PASSWORD: $DB_POSTGRESDB_PASSWORD
      POSTGRES_USER: $DB_POSTGRESDB_USER
      POSTGRES_DB: $DB_POSTGRESDB_DATABASE
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -h localhost -U $DB_POSTGRESDB_USER -d $DB_POSTGRESDB_DATABASE"]
      interval: 5s
      timeout: 5s
      retries: 10
    volumes:
      - /addon_configs/n8n/db:/var/lib/postgresql/data
    tmpfs:
      - /var/run/postgresql

image: n8nio/n8n:1.115.2
volumes:
  - /addon_configs/n8n/.n8n:/home/node/.n8n
